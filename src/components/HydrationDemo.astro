---
export interface HydrationDemoProps {
  title: string;
  strategy: 'visible' | 'idle' | 'load' | 'media';
  mediaQuery?: string;
  className?: string;
}

const {
  title,
  strategy,
  mediaQuery = '(min-width: 768px)',
  className = '',
} = Astro.props as HydrationDemoProps;

// Generate client directive
const getClientDirective = (hydrationStrategy: string, media?: string) => {
  switch (hydrationStrategy) {
    case 'visible':
      return 'client:visible';
    case 'idle':
      return 'client:idle';
    case 'load':
      return 'client:load';
    case 'media':
      return `client:media="${media}"`;
    default:
      return 'client:visible';
  }
};

const clientDirective = getClientDirective(strategy, mediaQuery);

// Get strategy description
const getStrategyDescription = (hydrationStrategy: string) => {
  switch (hydrationStrategy) {
    case 'visible':
      return 'Hydrates when the component enters the viewport';
    case 'idle':
      return 'Hydrates when the browser is idle';
    case 'load':
      return 'Hydrates immediately when the page loads';
    case 'media':
      return `Hydrates when media query matches: ${mediaQuery}`;
    default:
      return 'Unknown hydration strategy';
  }
};

const strategyDescription = getStrategyDescription(strategy);

// Ensure variables are used
void clientDirective;
void strategyDescription;
---

<!-- Server-rendered content (always visible) -->
<div class={`hydration-demo ${className}`} data-strategy={strategy}>
  <div class="bg-white rounded-lg border border-gray-200 p-6 shadow-sm">
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-lg font-semibold text-gray-900">{title}</h3>
      <span class={`inline-block px-3 py-1 text-xs font-medium rounded-full ${
        strategy === 'load' ? 'bg-red-100 text-red-800' :
        strategy === 'idle' ? 'bg-yellow-100 text-yellow-800' :
        strategy === 'visible' ? 'bg-green-100 text-green-800' :
        'bg-blue-100 text-blue-800'
      }`}>
        {strategy}
      </span>
    </div>
    
    <p class="text-sm text-gray-600 mb-4">
      {strategyDescription}
    </p>
    
    <!-- Static content (no JavaScript required) -->
    <div class="space-y-3">
      <div class="flex items-center gap-2">
        <div class="w-3 h-3 bg-gray-300 rounded-full"></div>
        <span class="text-sm text-gray-700">Server-rendered content</span>
      </div>
      
      <div class="hydration-status">
        <div class="flex items-center gap-2">
          <div class="w-3 h-3 bg-gray-300 rounded-full hydration-indicator"></div>
          <span class="text-sm text-gray-700 hydration-text">Waiting for hydration...</span>
        </div>
      </div>
      
      <!-- Interactive elements (enhanced with JavaScript) -->
      <div class="interactive-content">
        <button 
          class="px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
          disabled
        >
          Interactive Button (Disabled)
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Enhanced functionality (only when hydrated) -->
<script define:vars={{ strategy, title }} is:inline>
  class HydrationDemo {
    constructor(container) {
      this.container = container;
      this.indicator = container.querySelector('.hydration-indicator');
      this.text = container.querySelector('.hydration-text');
      this.button = container.querySelector('button');
      this.clickCount = 0;
      
      this.init();
    }
    
    init() {
      // Mark as hydrated
      this.updateStatus('hydrated', 'Component hydrated successfully!');
      
      // Enable interactive elements
      this.enableInteractivity();
      
      // Log hydration event for debugging
      if (import.meta.env.DEV) {
        console.log(`[Hydration] ${title} hydrated with strategy: ${strategy}`);
      }
    }
    
    updateStatus(status, message) {
      const statusColors = {
        waiting: 'bg-gray-300',
        hydrated: 'bg-green-500',
        interactive: 'bg-blue-500',
        error: 'bg-red-500'
      };
      
      this.indicator.className = `w-3 h-3 rounded-full hydration-indicator ${statusColors[status] || statusColors.waiting}`;
      this.text.textContent = message;
    }
    
    enableInteractivity() {
      // Enable the button
      this.button.disabled = false;
      this.button.textContent = 'Click Me!';
      
      // Add click handler
      this.button.addEventListener('click', this.handleClick.bind(this));
      
      // Update status
      this.updateStatus('interactive', 'Component is now interactive!');
    }
    
    handleClick() {
      this.clickCount++;
      
      // Update button text
      this.button.textContent = `Clicked ${this.clickCount} time${this.clickCount !== 1 ? 's' : ''}!`;
      
      // Add visual feedback
      this.button.classList.add('animate-pulse');
      setTimeout(() => {
        this.button.classList.remove('animate-pulse');
      }, 200);
      
      // Update status
      this.updateStatus('interactive', `Button clicked ${this.clickCount} times`);
    }
  }
  
  // Initialize when DOM is ready
  document.addEventListener('DOMContentLoaded', () => {
    const demoContainers = document.querySelectorAll(`[data-strategy="${strategy}"]`);
    demoContainers.forEach(container => {
      // Only initialize if not already initialized
      if (!container.classList.contains('hydrated')) {
        container.classList.add('hydrated');
        new HydrationDemo(container);
      }
    });
  });
</script>

<style>
  /* Base styles for all hydration demos */
  .hydration-demo {
    contain: layout style;
  }
  
  /* Smooth transitions for interactive elements */
  .hydration-demo button {
    transition: all 0.2s ease-in-out;
  }
  
  .hydration-demo .hydration-indicator {
    transition: background-color 0.3s ease-in-out;
  }
  
  /* Animation for button feedback */
  .animate-pulse {
    animation: pulse 0.2s ease-in-out;
  }
  
  @keyframes pulse {
    0%, 100% {
      transform: scale(1);
    }
    50% {
      transform: scale(1.05);
    }
  }
  
  /* Ensure content doesn't shift during hydration */
  .interactive-content {
    min-height: 40px; /* Reserve space for button */
  }
  
  .hydration-status {
    min-height: 20px; /* Reserve space for status */
  }
  
  /* Visual indicators for different strategies */
  [data-strategy="load"] {
    border-left: 4px solid #ef4444;
  }
  
  [data-strategy="idle"] {
    border-left: 4px solid #f59e0b;
  }
  
  [data-strategy="visible"] {
    border-left: 4px solid #10b981;
  }
  
  [data-strategy="media"] {
    border-left: 4px solid #3b82f6;
  }
</style>